# Backend架构文档

## 📋 概述

Werewolf Arena Backend采用现代化的分层架构设计，基于FastAPI框架构建，提供高性能的RESTful API和WebSocket实时通信服务。系统专注于AI驱动的狼人杀游戏逻辑，支持多模型对抗和实时游戏体验。

## 🏗️ 整体架构

```
┌─────────────────────────────────────────────────────────────┐
│                    FastAPI Application Layer                 │
├─────────────────────────────────────────────────────────────┤
│  API Routes  │  WebSocket  │  CORS Middleware  │  Health Check │
├─────────────────────────────────────────────────────────────┤
│                   Business Logic Layer                       │
├─────────────────────────────────────────────────────────────┤
│ Game Manager  │  LLM Client   │  Session Manager   │  Logger  │
├─────────────────────────────────────────────────────────────┤
│                     Core Game Engine                         │
├─────────────────────────────────────────────────────────────┤
│  Game Master  │  Game State  │  Player Models  │  Game Flow  │
├─────────────────────────────────────────────────────────────┤
│                    Configuration Layer                        │
├─────────────────────────────────────────────────────────────┤
│   Settings    │  Model Registry  │  Timing Config  │  Utils   │
└─────────────────────────────────────────────────────────────┘
```

## 📁 目录结构详解

### 🌐 API层 (`src/api/`)

#### 主应用 (`app.py`)
- **职责**: FastAPI应用生命周期管理
- **功能**:
  - 应用启动和关闭处理
  - 全局LLM客户端初始化
  - 路由注册和中间件配置
  - 健康检查端点
- **关键特性**:
  - 异步生命周期管理
  - CORS跨域支持
  - 全局错误处理

#### API路由 (`src/api/v1/routes/`)
- **`games.py`**: 游戏管理API
  - 游戏创建、启动、停止
  - 游戏状态查询
  - 游戏列表管理
- **`models.py`**: AI模型API
  - 可用模型列表
  - 模型配置信息
- **`status.py`**: 系统状态API
  - 服务健康状态
  - 系统运行信息
- **`timing.py`**: 时间配置API
  - 游戏时序配置
  - 延迟参数管理
- **`logs.py`**: 日志API
  - 游戏日志查询
  - 实时日志访问
- **`websocket.py`**: WebSocket实时通信
  - 游戏状态推送
  - 玩家行动通知
  - 实时事件广播

#### 数据模型 (`src/api/v1/schemas/`)
- **`game.py`**: 游戏相关数据模型
- **`model.py`**: AI模型数据模型
- **`player.py`**: 玩家数据模型

### 🎮 核心游戏引擎 (`src/core/`)

#### 游戏主控 (`src/core/game/game_master.py`)
- **职责**: 完整的狼人杀游戏流程控制
- **核心功能**:
  - 游戏轮次管理
  - 玩家行动协调（夜间击杀、保护、查验）
  - 白天讨论和投票流程
  - 胜负判定逻辑
- **特色功能**:
  - 实时WebSocket通知
  - 可配置游戏模式（normal, fast, slow, demo）
  - 优雅的游戏停止机制
  - 详细的推理日志记录

#### 游戏状态 (`src/core/models/game_state.py`)
- **State类**: 游戏全局状态管理
- **Round类**: 单轮游戏数据
- **功能**:
  - 玩家列表管理
  - 游戏进度跟踪
  - 胜负状态维护

#### 玩家模型 (`src/core/models/player.py`)
- **角色实现**: Villager, Werewolf, Seer, Doctor
- **AI能力**:
  - 智能对话生成
  - 投票决策逻辑
  - 角色特定行动
  - 推理和策略分析

#### 日志模型 (`src/core/models/logs.py`)
- **RoundLog类**: 轮次日志记录
- **VoteLog类**: 投票日志记录
- **功能**: 结构化游戏数据存储

### 🤖 服务层 (`src/services/`)

#### 游戏管理器 (`src/services/game_manager/`)
- **`session_manager.py`**: 游戏会话管理
  - 单例模式实现
  - 多游戏并发支持
  - 会话生命周期管理
  - WebSocket事件协调
- **`runner.py`**: 游戏运行器
  - 后台游戏执行
  - 线程池管理
  - 错误处理和恢复
- **`sequence_manager.py`**: 动作序列管理
  - 游戏动作枚举
  - 事件序列控制

#### LLM客户端系统 (`src/services/llm/`)
- **`client.py`**: 统一LLM客户端
  - 多提供商路由
  - 模型自动识别
  - 健康状态检查
- **`factory.py`**: LLM提供商工厂
- **`generator.py`**: 全局LLM生成器
- **`base.py`**: LLM提供商基类
- **`providers/`**: 具体提供商实现
  - `glm.py`: 智谱AI GLM模型
  - `openai.py`: OpenAI GPT模型
  - `openrouter.py`: OpenRouter聚合模型

#### 日志系统 (`src/services/logger/`)
- **`realtime_logger.py`**: 实时日志记录器
  - 结构化日志格式
  - 实时文件写入
  - WebSocket订阅机制
- **`game_logger.py`**: 游戏日志管理
  - 游戏数据保存
  - 日志目录管理

### ⚙️ 配置层 (`src/config/`)

- **`settings.py`**: 应用配置管理
  - 环境变量处理
  - API密钥管理
  - 服务配置参数
- **`loader.py`**: 模型注册表
  - 模型别名映射
  - 模型元数据管理
- **`timing_loader.py`**: 游戏时序配置
  - 动作延迟设置
  - 游戏模式配置

### 🔧 工具层 (`src/utils/`)

- **`helpers.py`**: 通用工具函数
  - 数据处理工具
  - 字符串处理函数
  - 时间格式化工具

## 🔄 数据流架构

### 游戏启动流程
```
用户请求 → API路由 → SessionManager → GameMaster → 游戏初始化
    ↓
WebSocket连接 ← 实时通知 ← 游戏事件 ← 游戏状态变化
```

### 游戏执行流程
```
GameMaster → 夜间行动 → 白天讨论 → 投票淘汰 → 胜负判定
    ↓
实时日志 → WebSocket推送 → 前端更新 → 用户界面
```

### AI调用流程
```
玩家行动 → LLM Client → 提供商路由 → API调用 → 响应处理
    ↓
结果解析 → 游戏状态更新 → 日志记录 → 事件通知
```

## 🔌 核心接口设计

### RESTful API
- **游戏管理**: `/api/v1/games/*`
- **模型信息**: `/api/v1/models/*`
- **系统状态**: `/api/v1/status/*`
- **日志查询**: `/api/v1/games/{id}/logs`

### WebSocket通信
- **连接端点**: `/ws/{session_id}`
- **消息类型**: 游戏状态、玩家行动、系统事件
- **实时推送**: 游戏进展、投票结果、阶段变化

## 🎯 关键设计决策

### 1. 分层架构
- **优势**: 职责清晰、易于维护、可扩展性强
- **实现**: API层、业务层、核心层、配置层清晰分离

### 2. 单例会话管理
- **优势**: 全局状态一致性、资源统一管理
- **实现**: GameSessionManager单例模式

### 3. 异步通信
- **优势**: 实时性强、用户体验佳
- **实现**: WebSocket + 事件驱动架构

### 4. 多模型支持
- **优势**: 灵活性高、可对比测试
- **实现**: 统一LLM客户端 + 工厂模式

### 5. 配置化设计
- **优势**: 易于调整、环境适应性强
- **实现**: 分层配置 + 环境变量支持

## 📊 性能特性

### 并发处理
- **游戏并发**: 支持多游戏同时进行
- **请求处理**: FastAPI异步处理
- **WebSocket**: 多客户端连接支持

### 资源管理
- **线程池**: 游戏执行线程池管理
- **内存优化**: 游戏状态高效存储
- **连接池**: LLM API连接复用

### 错误处理
- **全局异常**: 统一错误处理机制
- **优雅降级**: LLM服务不可用时的处理
- **日志记录**: 完整的错误追踪

## 🔧 开发指南

### 添加新游戏功能
1. 在`GameMaster`中实现新逻辑
2. 更新相关数据模型
3. 添加对应的API端点
4. 更新WebSocket事件类型

### 集成新AI模型
1. 在`providers/`目录下实现新的提供商
2. 更新`factory.py`注册新提供商
3. 在`settings.py`中添加配置选项
4. 更新模型注册表

### 扩展WebSocket功能
1. 在`websocket.py`中添加新事件类型
2. 更新`sequence_manager.py`中的动作枚举
3. 在前端添加对应的处理逻辑

## 📈 扩展性考虑

### 水平扩展
- **负载均衡**: 支持多实例部署
- **数据库**: 可扩展为分布式存储
- **缓存**: 可集成Redis缓存层

### 功能扩展
- **游戏模式**: 支持更多游戏变体
- **AI能力**: 支持更复杂的AI策略
- **实时性**: 支持更丰富的实时交互

---

*本文档描述了Werewolf Arena Backend的完整架构设计，为开发和维护提供详细指导。*