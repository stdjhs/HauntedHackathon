# Frontend架构文档

## 📋 概述

Werewolf Arena Frontend 是基于 Next.js 14 构建的现代化 Web 应用，采用 App Router 架构，提供直观的狼人杀游戏界面和实时交互体验。应用专注于用户体验优化，支持响应式设计和实时游戏状态同步。

## 🏗️ 整体架构

### 技术栈
- **框架**: Next.js 14 (App Router)
- **语言**: TypeScript 5.3+
- **UI 库**: Tailwind CSS 3.3+
- **状态管理**: Zustand 4.4+
- **HTTP 客户端**: Axios 1.6+
- **实时通信**: WebSocket API
- **图标库**: Lucide React
- **日期处理**: date-fns

### 架构层次
```
┌─────────────────────────────────────────────────────────────┐
│                    Next.js App Router                        │
├─────────────────────────────────────────────────────────────┤
│   Pages    │   Components   │   Hooks   │   Utils   │   API   │
├─────────────────────────────────────────────────────────────┤
│            Zustand State Management Layer                   │
├─────────────────────────────────────────────────────────────┤
│          WebSocket & HTTP Communication Layer               │
├─────────────────────────────────────────────────────────────┤
│                   Backend API Integration                   │
└─────────────────────────────────────────────────────────────┘
```

## 📁 目录结构详解

### 🌐 应用页面 (`src/app/`)

#### 根布局 (`layout.tsx`)
- **职责**: 全局布局和样式配置
- **功能**:
  - 字体配置 (Inter Google Font)
  - 全局样式应用
  - 元数据设置
  - HTML 结构定义

#### 主页 (`page.tsx`)
- **职责**: 游戏启动和配置界面
- **核心功能**:
  - AI 模型选择 (村民 vs 狼人)
  - 游戏参数配置 (讨论时间、最大轮数)
  - 自定义玩家名称设置
  - 游戏启动控制
  - 模型状态展示
- **状态管理**: 集成 Zustand store 进行状态管理
- **自动跳转**: 游戏启动成功后自动跳转到直播页面

#### 直播页面 (`live/[sessionId]/page.tsx`)
- **职责**: 实时游戏展示界面
- **核心功能**:
  - 实时游戏状态显示
  - WebSocket 连接管理
  - 游戏进度可视化
  - 玩家状态实时更新
- **动态路由**: 基于 sessionId 的动态页面

#### 日志页面 (`logs/[sessionId]/page.tsx`)
- **职责**: 游戏日志查看界面
- **核心功能**:
  - 历史游戏日志展示
  - 实时日志流
  - 日志搜索和过滤
  - 游戏回放功能

### 🧩 组件系统 (`src/components/`)

#### UI 基础组件 (`src/components/ui/`)
- **Button.tsx**: 可配置按钮组件
  - 支持多种变体 (primary, secondary, danger)
  - 加载状态和禁用状态
  - 尺寸配置 (sm, md, lg)
- **Card.tsx**: 卡片容器组件
  - 统一的边框和阴影样式
  - 响应式布局支持
- **Input.tsx**: 输入框组件
  - 表单验证支持
  - 错误状态显示
  - 帮助文本配置
- **Select.tsx**: 下拉选择组件
  - 搜索功能支持
  - 多选和单选模式
  - 禁用选项处理
- **Badge.tsx**: 标签组件
  - 状态指示器
  - 颜色主题配置
  - 尺寸变体

#### 游戏专用组件 (`src/components/game/`)
- **GameLog.tsx**: 游戏日志显示组件
  - 实时日志流处理
  - 自动滚动到底部
  - 日志分类和样式化
- **PlayerCard.tsx**: 玩家信息卡片
  - 玩家状态显示 (存活/淘汰)
  - 角色标识
  - 动作历史记录
- **GameStats.tsx**: 游戏统计信息
  - 实时数据更新
  - 图表可视化
  - 关键指标展示
- **LiveGameProgress.tsx**: 实时游戏进度
  - 阶段进度条
  - 时间显示
  - 状态转换动画
- **PlayerInteractions.tsx**: 玩家交互界面
  - 投票操作
  - 动作历史
  - 交互反馈
- **GameTimeline.tsx**: 游戏时间线
  - 事件时间轴
  - 关键节点标记
  - 可展开的详细信息

### 🔧 工具和库 (`src/lib/`)

#### API 客户端 (`src/lib/api/`)
- **client.ts**: HTTP 客户端配置
  - Axios 实例配置
  - 请求/响应拦截器
  - 错误处理机制
- **games.ts**: 游戏相关 API
  - 游戏启动接口
  - 状态查询接口
  - 游戏停止接口
- **models.ts**: 模型信息 API
  - 可用模型列表
  - 模型详细信息
  - 健康状态检查
- **websocket.ts**: WebSocket 客户端
  - 连接管理
  - 自动重连机制
  - 事件处理系统
  - 错误恢复策略

#### 状态管理 (`src/lib/store/`)
- **gameStore.ts**: 游戏状态管理
  - Zustand store 配置
  - 游戏数据状态
  - UI 状态管理
  - 异步操作处理
- **uiStore.ts**: UI 状态管理
  - 全局 UI 状态
  - 主题配置
  - 布局状态

#### 自定义 Hooks (`src/lib/hooks/`)
- **useGame.ts**: 游戏逻辑 Hook
  - 游戏状态订阅
  - 游戏操作封装
  - 副作用处理
- **useWebSocket.ts**: WebSocket 连接 Hook
  - 连接生命周期管理
  - 事件订阅/取消订阅
  - 自动清理机制
- **useModels.ts**: 模型信息 Hook
  - 模型数据获取
  - 缓存管理
  - 错误重试
- **usePerformanceOptimizations.ts**: 性能优化 Hook
  - 组件懒加载
  - 防抖节流
  - 内存优化

#### 类型定义 (`src/types/`)
- **api.ts**: API 响应类型
  - 接口数据结构
  - 错误类型定义
- **game.ts**: 游戏数据类型
  - 游戏状态类型
  - 玩家数据类型
  - 事件类型定义
- **index.ts**: 通用类型定义
  - 全局类型导出
  - 工具类型

## 🔄 数据流架构

### 游戏启动流程
```
用户配置 → 页面状态 → API 调用 → 后端响应 → 状态更新 → 页面跳转
    ↓
WebSocket 连接 ← 自动建立 ← 游戏会话 ID ← 响应数据
```

### 实时数据流
```
WebSocket 事件 → 消息解析 → 状态更新 → 组件重渲染 → UI 更新
    ↓
错误处理 ← 重连机制 ← 连接状态监控 ← 心跳检测
```

### 状态管理模式
```
Zustand Store
├── Game State (游戏数据)
│   ├── 当前游戏信息
│   ├── 游戏历史记录
│   └── 游戏设置
├── UI State (界面状态)
│   ├── 加载状态
│   ├── 错误信息
│   └── 用户交互状态
└── Connection State (连接状态)
    ├── WebSocket 状态
    └── 连接质量监控
```

## 🔌 核心功能实现

### WebSocket 实时通信
- **连接管理**: 单例模式 WebSocket 客户端
- **自动重连**: 指数退避重连策略
- **事件系统**: 类型安全的事件处理
- **错误恢复**: 连接失败自动恢复
- **心跳检测**: 保持连接活跃状态

### 状态管理策略
- **分片状态**: 游戏状态与 UI 状态分离
- **选择器优化**: 避免不必要的重渲染
- **中间件集成**: 开发工具和持久化支持
- **类型安全**: 完整的 TypeScript 类型覆盖

### 性能优化
- **代码分割**: 基于路由的自动代码分割
- **组件懒加载**: 按需加载大型组件
- **状态优化**: Zustand 选择器模式
- **缓存策略**: API 响应缓存和重用
- **防抖节流**: 用户输入优化

## 🎯 关键设计决策

### 1. App Router 架构
- **优势**: SEO 友好、更好的性能、内置布局支持
- **实现**: 利用 Next.js 14 的最新特性
- **收益**: 更好的用户体验和开发体验

### 2. Zustand 状态管理
- **优势**: 轻量级、类型安全、简单易用
- **实现**: 分片 store 和选择器模式
- **收益**: 更好的性能和开发效率

### 3. TypeScript 全覆盖
- **优势**: 类型安全、更好的 IDE 支持、减少运行时错误
- **实现**: 严格的类型定义和检查
- **收益**: 更可靠的代码和更好的维护性

### 4. 组件化设计
- **优势**: 可复用性、可维护性、测试友好
- **实现**: 原子设计模式和 prop-types
- **收益**: 更快的开发和更好的代码质量

## 📊 性能特性

### 渲染性能
- **服务端渲染**: Next.js SSR 支持
- **静态生成**: 页面级别的静态优化
- **增量再生**: ISR 支持
- **图片优化**: Next.js Image 组件

### 包大小优化
- **Tree Shaking**: 自动移除未使用代码
- **动态导入**: 按需加载模块
- **Bundle 分析**: webpack-bundle-analyzer 集成
- **代码压缩**: 生产环境自动压缩

### 运行时性能
- **React 18**: 并发特性支持
- **Memo 优化**: 组件级别的缓存
- **回调优化**: useCallback 和 useMemo
- **虚拟化**: 大列表性能优化

## 🔧 开发指南

### 本地开发
```bash
# 安装依赖
npm install

# 开发模式启动
npm run dev

# 类型检查
npm run type-check

# 代码检查
npm run lint

# 构建生产版本
npm run build
```

### 组件开发规范
- **命名规范**: PascalCase 组件名
- **Props 类型**: 完整的 TypeScript 接口
- **默认值**: 提供合理的默认 props
- **文档注释**: JSDoc 格式的组件文档
- **测试覆盖**: 单元测试和集成测试

### 状态管理最佳实践
- **状态分片**: 按功能域分离状态
- **选择器使用**: 避免不必要的订阅
- **异步处理**: 统一的异步操作模式
- **错误边界**: 适当的错误处理机制

## 📈 扩展性考虑

### 功能扩展
- **插件系统**: 可插拔的功能模块
- **主题系统**: 可定制的 UI 主题
- **国际化**: i18n 支持准备
- **PWA 支持**: 离线功能能力

### 技术升级
- **框架升级**: Next.js 版本升级路径
- **依赖更新**: 定期的依赖包更新
- **性能监控**: 集成性能监控工具
- **错误追踪**: 集成错误报告服务

---

*本文档详细描述了Frontend的完整架构设计，为开发和维护提供全面的技术参考。*