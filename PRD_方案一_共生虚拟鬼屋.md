# 产品需求文档（PRD）
## 方案一：共生 · 虚拟鬼屋

**文档版本**：V1.0
**创建日期**：2025-10-30
**产品代号**：SYMBIO-001
**项目周期**：24小时
**团队规模**：4人

---

## 📋 目录

1. [产品概述](#1-产品概述)
2. [产品目标](#2-产品目标)
3. [用户画像](#3-用户画像)
4. [功能需求](#4-功能需求)
5. [非功能需求](#5-非功能需求)
6. [用户故事](#6-用户故事)
7. [系统架构](#7-系统架构)
8. [数据模型](#8-数据模型)
9. [接口设计](#9-接口设计)
10. [UI/UX原型](#10-uiux原型)
11. [验收标准](#11-验收标准)
12. [项目计划](#12-项目计划)
13. [风险评估](#13-风险评估)
14. [成功指标](#14-成功指标)

---

## 1. 产品概述

### 1.1 产品定位
**共生·虚拟鬼屋**是一款基于情绪驱动的多人协作恐怖逃生游戏。4名玩家组成"求生小队"，在虚拟鬼屋中协作完成任务，通过生理数据采集与情绪识别技术，实现真正的"命运相连"与"恐惧共鸣"。

### 1.2 核心价值主张
- **社交破冰**：通过游戏机制强制团队协作，快速拉近距离
- **情绪连接**：实时情绪感知与传递，创造"心灵相通"的体验
- **共同成长**：在恐怖与刺激中建立深度信任与友谊

### 1.3 产品特色
1. **生理数据驱动**：心率、表情、语音颤抖等多维度恐惧检测
2. **协作即生存**：独自无法完成，必须团队配合
3. **情绪可视化**：恐惧云图实时展示，情感流动可见
4. **虚实融合**：小黑屋现实体验影响虚拟世界进程

---

## 2. 产品目标

### 2.1 业务目标
| 目标类型 | 具体指标 | 目标值 |
|----------|----------|--------|
| 现场演示 | 完整游戏流程演示 | 10分钟无卡顿 |
| 现场互动 | 观众参与度 | 80%以上观众主动体验 |
| 技术创新 | 情绪识别准确率 | ≥85% |
| 社交效果 | 团队协作流畅度 | 4人无缝配合 |
| 情绪体验 | 情绪曲线完整性 | 5个阶段完整呈现 |

### 2.2 用户目标
- **破冰效果**：原本陌生的4人，在50分钟内建立深度信任
- **情绪共鸣**：体验"心跳同步"、"恐惧共享"的神奇时刻
- **难忘回忆**：创造比普通游戏更深刻的集体记忆
- **恐惧转化**：通过团队力量将恐惧转化为温暖与连接

---

## 3. 用户画像

### 3.1 主要用户群体

#### 用户群体A：社恐探索者
- **年龄**：18-25岁
- **特征**：
  - 想要社交但害怕主动
  - 寻求安全的社交环境
  - 对新技术感兴趣
  - 喜欢沉浸式体验
- **需求**：通过低压力方式与陌生人建立连接

#### 用户群体B：刺激寻求者
- **年龄**：20-30岁
- **特征**：
  - 喜欢恐怖/刺激内容
  - 追求独特体验
  - 社交活跃但浅层
  - 愿意尝试新事物
- **需求**：寻找比普通娱乐更刺激的体验

#### 用户群体C：团队协作者
- **年龄**：22-35岁
- **特征**：
  - 重视团队合作
  - 寻求深度协作体验
  - 关注团队建设
  - 企业/组织背景
- **需求**：通过游戏提升团队凝聚力和协作能力

### 3.2 用户场景
| 场景 | 用户 | 目标 | 痛点 |
|------|------|------|------|
| 现场参赛 | 黑客松参赛者 | 快速破冰、团队协作 | 陌生人间难以快速建立信任 |
| 团队建设 | 企业HR/管理者 | 提升团队凝聚力 | 传统团建活动枯燥、参与度低 |
| 娱乐体验 | 年轻人 | 寻找独特社交体验 | 普通游戏缺乏深度连接 |
| 心理探索 | 心理健康关注者 | 情绪认知与转化 | 缺乏有趣的情感体验工具 |

---

## 4. 功能需求

### 4.1 核心功能模块

#### F1: 多人协作系统
**功能描述**：支持4名玩家实时协作，共同完成逃生任务

**功能清单**：
- [ ] F1.1 房间管理系统（创建/加入/匹配）
- [ ] F1.2 玩家状态同步（位置/动作/状态）
- [ ] F1.3 实时通信（文字/语音/视频）
- [ ] F1.4 任务分配与进度追踪
- [ ] F1.5 协作解谜机制

**详细需求**：
```
F1.1 房间管理系统
- 房间创建：输入房间名、选择主题场景
- 房间加入：通过房间码或快速匹配
- 房间状态：等待中/游戏中/已结束
- 玩家列表：显示昵称、状态、连接状态
- 权限管理：房主可踢人、开始游戏

F1.2 玩家状态同步
- 位置同步：每个玩家的3D坐标实时同步
- 动作同步：开门、拾取、查看等动作广播
- 状态同步：生命值、恐惧值、道具状态
- 延迟补偿：网络延迟≤100ms感知不到
- 状态冲突解决：最后写入优先

F1.3 实时通信
- 文字聊天：全局/私聊，支持快捷短语
- 语音聊天：Push-to-Talk，音量调节
- 视频共享：玩家视角实时共享给队友
- 表情系统：预设表情，快速回应

F1.4 任务分配与进度
- 主线任务：4个楼层协作逃生
- 支线任务：可选的加分任务
- 进度追踪：实时显示任务完成度
- 依赖关系：任务间的逻辑依赖
- 进度广播：任务进度自动广播给全队

F1.5 协作解谜
- 多楼层联动：1-4楼任务相互依赖
- 信息传递：楼层间信息传递机制
- 同步操作：关键操作需要多人确认
- 时间限制：整体倒计时增加紧迫感
```

#### F2: 情绪识别系统
**功能描述**：通过多模态数据采集与分析，实时识别玩家恐惧等级

**功能清单**：
- [ ] F2.1 面部表情识别
- [ ] F2.2 心率监测
- [ ] F2.3 语音颤抖分析
- [ ] F2.4 恐惧值计算
- [ ] F2.5 情绪数据可视化

**详细需求**：
```
F2.1 面部表情识别
- 技术：MediaPipe + TensorFlow.js
- 频率：30FPS实时检测
- 表情库：惊讶、恐惧、紧张、平静等7种
- 准确率：≥85%
- 隐私：本地处理，不上传原始图像

F2.2 心率监测
- 设备：Web摄像头 + PPG算法
- 采样率：每秒1次
- 范围：60-180 BPM
- 异常处理：摄像头遮挡自动跳过
- 准确性：±5 BPM误差

F2.3 语音颤抖分析
- 技术：Tone.js音频分析
- 指标：基频变化、抖动度、响度变化
- 采样：每2秒分析一次
- 过滤：背景噪音自动过滤
- 阈值：超过正常波动20%标记颤抖

F2.4 恐惧值计算
- 加权算法：
  面部恐惧表情：40%
  心率异常升高：30%
  语音颤抖：20%
  键盘抖动（可选）：10%
- 平滑处理：移动平均，3秒窗口
- 更新频率：每秒更新一次
- 数值范围：0-100分

F2.5 情绪数据可视化
- 恐惧云图：实时渲染恐惧分布热力图
- 折线图：个人恐惧值历史曲线
- 雷达图：4人情绪状态对比
- 动画效果：恐惧值越高，粒子越剧烈
- 数据导出：可选导出情绪数据报表
```

#### F3: 游戏逻辑引擎
**功能描述**：驱动游戏进程的核心逻辑系统

**功能清单**：
- [ ] F3.1 场景管理系统
- [ ] F3.2 谜题生成器
- [ ] F3.3 惊吓触发器
- [ ] F3.4 情绪自适应算法
- [ ] F3.5 游戏结算系统

**详细需求**：
```
F3.1 场景管理系统
- 场景类型：废弃医院（首发场景）
- 楼层设计：
  1楼：大厅（入口/钥匙区）
  2楼：配电室（供电区）
  3楼：档案室（密码区）
  4楼：控制室（逃生区）
- 可交互物体：门、柜子、开关、文件等
- 场景状态：物体位置、开关状态、线索可见性

F3.2 谜题生成器
- 主谜题链：
  1楼找钥匙 → 2楼供电 → 3楼查密码 → 4楼逃生
- 线索分布：每个楼层3-5个线索点
- 线索依赖：上层需要下层提供信息
- 难度调节：根据平均恐惧值调整线索隐晦度
- 时间限制：总倒计时45分钟

F3.3 惊吓触发器
- 触发条件：
  - 打开特定柜子（剧情化Jump）
  - 低恐惧值时给予缓冲
  - 高恐惧值时适度降低
  - 团队陷入僵局时给予提示
- 效果：全队同步Jump + 恐怖音效 + 画面闪烁
- 频率：每5-8分钟一次
- 剧本化：Jump不是随机，而是剧情需要

F3.4 情绪自适应算法
- 触发逻辑：
  - 平均恐惧 < 40：增加刺激元素
  - 40 ≤ 平均恐惧 ≤ 70：保持现状
  - 平均恐惧 > 70：提供缓冲/安全感
- 调整内容：
  - 线索明显度
  - 惊吓强度
  - 音乐/音效氛围
  - NPC提示频率
- 响应时间：检测到情绪变化后10秒内调整
- 过度保护：连续5分钟高恐惧自动启动保护

F3.5 游戏结算系统
- 成功条件：
  - 4楼启动逃生装置
  - 全队在时间结束前逃脱
- 评分维度：
  - 完成时间（40%）
  - 团队协作度（30%）
  - 情绪管理（20%）
  - 线索发现率（10%）
- 成就系统：
  - 最佳搭档（相互救赎次数最多）
  - 冷静大师（恐惧值波动最小）
  - 线索大师（发现线索最多）
- 结果展示：
  - 团队照片（游戏结束截图）
  - 情绪曲线回顾
  - 成就徽章
  - 分享到社交媒体
```

#### F4: 牺牲与救赎系统
**功能描述**：独特的团队互助机制

**功能清单**：
- [ ] F4.1 牺牲机制
- [ ] F4.2 救赎任务
- [ ] F4.3 复活系统
- [ ] F4.4 情感激励

**详细需求**：
```
F4.1 牺牲机制
- 触发：玩家可主动选择牺牲（按钮）
- 效果：
  - 牺牲者承受所有恐怖效果
  - 其他3人恐惧值降低50%
  - 牺牲者暂时"昏迷"（无法操作30秒）
- 限制：每玩家限1次
- 时机：只能在团队平均恐惧 > 70时使用

F4.2 救赎任务
- 触发：有人牺牲后自动触发
- 任务类型（随机选择）：
  - 全队完成特定协作操作
  - 快速找到隐藏线索
  - 集体唱歌/喊话打破诅咒
  - 互相拥抱/支持动作
- 时间限制：2分钟内完成
- 失败惩罚：牺牲者永久昏迷（团队失败）

F4.3 复活系统
- 成功完成救赎任务 → 牺牲者复活
- 复活效果：
  - 恐惧值清零
  - 获得"勇气光环"（降低全队恐惧10%）
  - 解锁特殊道具或线索
- 失败处理：游戏继续但缺少1人（难度增加）

F4.4 情感激励
- 复活时刻：全队庆祝动画
- 救赎成就：特殊徽章奖励
- 团队感言：每人可说一句话
- 记忆存档：记录"英勇时刻"
```

#### F5: 虚实融合系统
**功能描述**：现实体验与虚拟世界的交互

**功能清单**：
- [ ] F5.1 小黑屋任务
- [ ] F5.2 现实线索
- [ ] F5.3 NPC干扰
- [ ] F5.4 Jumpscare联动

**详细需求**：
```
F5.1 小黑屋任务
- 触发：每15分钟随机触发1次
- 流程：
  - 系统提示："需要1人进入小黑屋获得线索"
  - 玩家自愿或投票决定
  - 现实工作人员引导进入小黑屋
  - 小黑屋内的体验影响游戏进程
- 小黑屋内容：
  - 读取神秘符号
  - 面对镜子中的"自己"
  - 获得实体道具或纸条
  - 感受特殊音效/震动
- 游戏影响：
  - 获得虚拟世界的关键线索
  - 解锁特殊门或密码
  - 获得NPC的特殊对话

F5.2 现实线索
- 类型：
  - 实体纸条：包含虚拟世界的密码
  - 道具：实体钥匙打开虚拟门
  - 手势：特定手势触发虚拟事件
  - 暗号：NPC对话需要特定回答
- 同步机制：现实操作 → 5秒内反映到虚拟世界
- 反馈效果：虚拟世界给出确认提示
- 失败处理：操作错误可重试

F5.3 NPC干扰
- 角色：鬼魂管理员、混乱使者、引导者
- 行为：
  - 提供误导信息（增加难度）
  - 给予希望线索（缓解恐惧）
  - 质疑玩家决策（制造怀疑）
  - 解释游戏背景（增强沉浸）
- 触发时机：
  - 玩家卡壳时主动出现
  - 平均恐惧过高时给予安慰
  - 进度过快时增加阻碍
- 对话系统：预设台词库+AI生成补充

F5.4 Jumpscare联动
- 触发点：与游戏剧情结合
  - 打开柜子 → Jump（符合剧情）
  - 看到鬼魂 → Jump（视觉冲击）
  - 解开谜题 → Jump（惊喜转惊吓）
- 全队同步：Jump发生时所有玩家同时经历
- 后续处理：AI角色解释Jump原因
  - "这是它的警告..."
  - "你们触碰了不该触碰的..."
  - "恭喜，通过了它的考验"
- 情绪引导：Jump后将恐惧转化为团队凝聚力
```

---

## 5. 非功能需求

### 5.1 性能需求

| 指标 | 目标值 | 测量方法 |
|------|--------|----------|
| 页面加载时间 | ≤3秒 | 首次进入游戏页面 |
| 游戏帧率 | ≥30 FPS | Three.js渲染帧率监控 |
| 网络延迟 | ≤100ms | 玩家操作响应时间 |
| API响应时间 | ≤200ms | 后端接口平均响应时间 |
| 并发支持 | 4人同房间 | 压力测试验证 |

### 5.2 可用性需求

| 需求 | 说明 | 验收标准 |
|------|------|----------|
| 兼容性 | 支持主流浏览器 | Chrome/Edge/Firefox/Safari |
| 设备支持 | 笔记本电脑/台式机 | 1080P分辨率，8GB内存 |
| 网络要求 | 宽带≥10Mbps | 低于此速度自动降级功能 |
| 容错能力 | 网络断开重连 | 30秒内自动恢复连接 |
| 数据持久化 | 游戏进度保存 | 意外退出后可恢复进度 |

### 5.3 安全需求

| 安全项 | 要求 | 实现方式 |
|--------|------|----------|
| 隐私保护 | 情绪数据本地处理 | 不上传原始图像/音频 |
| 数据加密 | 传输数据加密 | WebSocket over TLS |
| 权限控制 | 房间访问控制 | 房间码+房主权限 |
| 输入验证 | 防止恶意输入 | 前后端双重验证 |
| 资源防护 | API调用限制 | 频率限制+异常监控 |

### 5.4 可维护性

| 维度 | 要求 | 措施 |
|------|------|------|
| 代码质量 | 规范统一 | ESLint + Prettier |
| 日志系统 | 完整记录 | 结构化日志+监控告警 |
| 错误追踪 | 快速定位 | 前端Sentry+后端日志 |
| 版本管理 | Git规范 | 分支管理+代码审查 |
| 文档完整 | 技术文档 | 代码注释+API文档 |

---

## 6. 用户故事

### 6.1 核心用户故事

#### 故事1：破冰体验
```
作为一名社恐的参赛者
我希望快速与陌生人建立信任
这样我就不会因为害羞而无法融入团队

验收标准：
- 4名玩家在5分钟内从陌生到基本熟悉
- 游戏中有至少3次需要主动沟通的场景
- 90%的玩家反馈"感觉距离拉近了"
```

#### 故事2：协作逃生
```
作为一名游戏玩家
我需要与队友协作完成复杂谜题
这样才能体验真正的团队配合

验收标准：
- 每个玩家都必须承担关键任务
- 单人无法独立完成任何主任务
- 团队配合度影响游戏结局
- 至少需要3次跨楼层信息传递
```

#### 故事3：恐惧共鸣
```
作为一名体验者
我希望通过游戏感受队友的情绪
这样我们能真正"心灵相通"

验收标准：
- 1人看到恐怖场景，其他3人能实时感受
- 恐惧值可视化展示，清晰可见
- 情绪传递延迟≤3秒
- 至少体验1次集体Jump的震撼
```

#### 故事4：相互救赎
```
作为一名团队成员
我愿意牺牲自己保护队友
这样我们的友谊会更深厚

验收标准：
- 每玩家至少1次牺牲机会
- 救赎任务需要团队协作完成
- 复活成功有庆祝仪式
- 85%以上玩家选择牺牲自己保护团队
```

### 6.2 详细用户旅程

#### 旅程1：进入游戏（0-5分钟）
| 时间 | 用户行为 | 系统响应 | 情绪状态 |
|------|----------|----------|----------|
| 0' | 加入房间，看到队友 | 显示队友昵称和状态 | 好奇 |
| 1' | 简单自我介绍 | 语音/文字交流通道开启 | 紧张 |
| 2' | 阅读游戏说明 | 引导动画展示玩法 | 期待 |
| 3' | 选择角色/昵称 | 角色分配成功提示 | 兴奋 |
| 4' | 点击"开始游戏" | 进入3D鬼屋场景 | 紧张 |
| 5' | 环顾四周，互相打招呼 | 场景音效+队友可见 | 期待 |

#### 旅程2：探索解谜（5-35分钟）
| 时间 | 用户行为 | 系统响应 | 情绪状态 |
|------|----------|----------|----------|
| 5-10' | 各自探索楼层 | 实时位置同步 | 好奇 |
| 10-15' | 发现线索但不懂 | 寻求队友帮助 | 困惑 |
| 15-20' | 跨楼层传递信息 | 协作任务建立 | 互助 |
| 20-25' | 触发第一次Jump | 全队同步惊吓 | 恐惧 |
| 25-30' | 团队陷入僵局 | NPC给予提示 | 焦虑 |
| 30-35' | 发现关键线索 | 情绪值飙升 | 兴奋 |

#### 旅程3：高潮与逃生（35-50分钟）
| 时间 | 用户行为 | 系统响应 | 情绪状态 |
|------|----------|----------|----------|
| 35-40' | 有人牺牲自己 | 其他队员恐惧降低50% | 感动 |
| 40-43' | 完成救赎任务 | 队友复活+光环效果 | 庆祝 |
| 43-47' | 最后冲刺逃生 | 倒计时加速+紧张音乐 | 刺激 |
| 47-50' | 成功逃脱 | 成就结算+团队合影 | 成就 |
| 50' | 分享感受 | 情绪曲线回顾 | 满足 |

---

## 7. 系统架构

### 7.1 整体架构图

```
┌─────────────────────────────────────────────────────────┐
│                    客户端层 (Client)                     │
├─────────────────────┬───────────────────────────────────┤
│   前端1 (React)     │        前端2 (Next.js)             │
│ ┌─────────────────┐ │ ┌───────────────────────────────┐ │
│ │ 3D鬼屋场景渲染  │ │ │ 实时协作界面                  │ │
│ │ Three.js        │ │ │ 任务板/进度同步               │ │
│ │                 │ │ │ Socket.io客户端               │ │
│ │ 情绪识别        │ │ │ 情绪数据可视化                │ │
│ │ MediaPipe       │ │ │ D3.js/Chart.js                │ │
│ │                 │ │ │                               │ │
│ │ 视频共享        │ │ │ 玩家状态监控                  │ │
│ │ WebRTC          │ │ │ UI控制面板                    │ │
│ └─────────────────┘ │ └───────────────────────────────┘ │
└─────────────────────┴───────────────────────────────────┘
                              │
                    ┌─────────┴─────────┐
                    │  WebSocket连接     │
                    │  (实时双向通信)    │
                    └─────────┬─────────┘
                              │
┌─────────────────────────────────────────────────────────┐
│                   服务端层 (Server)                      │
│ ┌─────────────────────────────────────────────────────┐ │
│ │               API Gateway (Nginx)                   │ │
│ │              负载均衡 + SSL Termination              │ │
│ └─────────────────────┬───────────────────────────────┘ │
│ ┌─────────────────────┴───────────────────────────────┐ │
│ │            WebSocket Server (FastAPI)               │ │
│ │  ┌──────────────────────────────────────────────┐   │ │
│ │  │         多人状态同步服务                      │   │ │
│ │  │      - 房间管理                              │   │ │
│ │  │      - 玩家位置同步                          │   │ │
│ │  │      - 任务进度管理                          │   │ │
│ │  └──────────────────────────────────────────────┘   │ │
│ │  ┌──────────────────────────────────────────────┐   │ │
│ │  │         游戏逻辑引擎                          │   │ │
│ │  │      - 场景状态管理                          │   │ │
│ │  │      - 谜题生成器                            │   │ │
│ │  │      - 惊吓触发器                            │   │ │
│ │  └──────────────────────────────────────────────┘   │ │
│ │  ┌──────────────────────────────────────────────┐   │ │
│ │  │         情绪分析引擎                          │   │ │
│ │  │      - 数据采集聚合                          │   │ │
│ │  │      - 恐惧值计算                            │   │ │
│ │  │      - 情绪自适应                            │   │ │
│ │  └──────────────────────────────────────────────┘   │ │
│ └─────────────────────────────────────────────────────┘ │
└─────────────────────┬───────────────────────────────────┘
                      │
┌─────────────────────┴───────────────────────────────────┐
│                    数据层 (Data)                        │
│ ┌─────────────────────┬─────────────────────────────────┤
│ │      Redis         │         PostgreSQL              │
│ │   (状态缓存)       │        (持久化数据)              │
│ │ ┌─────────────────┐ │ ┌─────────────────────────────┐ │
│ │ │ 房间状态缓存     │ │ │ 用户信息                    │ │
│ │ │ 玩家状态缓存     │ │ │ 游戏记录                    │ │
│ │ │ 情绪数据缓存     │ │ │ 成就系统                    │ │
│ │ │ 会话数据         │ │ │ 配置数据                    │ │
│ │ └─────────────────┘ │ └─────────────────────────────┘ │
│ └─────────────────────┴─────────────────────────────────┘ │
└─────────────────────────────────────────────────────────┘
```

### 7.2 技术栈选择

#### 前端技术栈
| 技术 | 版本 | 用途 | 选择理由 |
|------|------|------|----------|
| React | 18+ | 前端框架 | 成熟稳定，生态丰富 |
| Next.js | 14+ | 服务端渲染 | SEO优化，性能更好 |
| Three.js | r155+ | 3D渲染 | WebGL封装，简单易用 |
| Socket.io-client | 4+ | WebSocket | 自动重连，房间管理 |
| WebRTC | 原生 | 视频共享 | P2P传输，低延迟 |
| MediaPipe | 0.10 | 情绪识别 | 谷歌开源，准确率高 |
| Tone.js | 0.13 | 音频分析 | 音频特征提取 |
| D3.js | 7+ | 数据可视化 | 灵活强大，定制性高 |
| Tailwind CSS | 3+ | 样式框架 | 快速开发，响应式 |

#### 后端技术栈
| 技术 | 版本 | 用途 | 选择理由 |
|------|------|------|----------|
| Python | 3.11+ | 编程语言 | AI生态丰富，开发快 |
| FastAPI | 0.104+ | Web框架 | 高性能，自动文档 |
| WebSocket | 原生 | 实时通信 | 低延迟双向通信 |
| Redis | 7+ | 缓存/会话 | 高性能，持久化支持 |
| PostgreSQL | 15+ | 关系数据库 | 可靠性高，JSON支持 |
| SQLAlchemy | 2.0 | ORM | 异步支持，类型安全 |
| Pydantic | 2.4 | 数据验证 | 自动验证，序列化 |
| Celery | 5.3 | 异步任务 | 任务队列，分布式 |
| Sentry | SDK | 错误监控 | 快速定位问题 |

#### AI/ML技术栈
| 技术 | 用途 | 说明 |
|------|------|------|
| TensorFlow.js | 浏览器端ML | 情绪识别，客户端处理 |
| face-api.js | 面部识别 | 基于TensorFlow.js |
| OpenCV-Python | 服务端图像处理 | 备用方案 |
| scikit-learn | 机器学习 | 情绪值计算模型 |

---

## 8. 数据模型

### 8.1 数据库设计

#### 8.1.1 用户表 (users)
```sql
CREATE TABLE users (
    id UUID PRIMARY KEY DEFAULT gen_random_uuid(),
    nickname VARCHAR(50) NOT NULL,
    avatar_url VARCHAR(255),
    created_at TIMESTAMP DEFAULT NOW(),
    updated_at TIMESTAMP DEFAULT NOW(),
    is_online BOOLEAN DEFAULT FALSE,
    last_seen TIMESTAMP DEFAULT NOW()
);

-- 索引
CREATE INDEX idx_users_online ON users(is_online);
CREATE INDEX idx_users_last_seen ON users(last_seen);
```

#### 8.1.2 房间表 (rooms)
```sql
CREATE TABLE rooms (
    id UUID PRIMARY KEY DEFAULT gen_random_uuid(),
    room_code VARCHAR(6) UNIQUE NOT NULL,
    creator_id UUID REFERENCES users(id),
    room_name VARCHAR(100) NOT NULL,
    status VARCHAR(20) DEFAULT 'waiting', -- waiting, playing, finished
    scene_type VARCHAR(50) DEFAULT 'hospital',
    max_players INTEGER DEFAULT 4,
    current_players INTEGER DEFAULT 0,
    created_at TIMESTAMP DEFAULT NOW(),
    started_at TIMESTAMP,
    finished_at TIMESTAMP,
    total_duration INTEGER, -- 秒
    settings JSONB DEFAULT '{}' -- 难度、音效等设置
);

-- 索引
CREATE INDEX idx_rooms_code ON rooms(room_code);
CREATE INDEX idx_rooms_status ON rooms(status);
CREATE INDEX idx_rooms_creator ON rooms(creator_id);
```

#### 8.1.3 玩家房间关联表 (room_players)
```sql
CREATE TABLE room_players (
    id UUID PRIMARY KEY DEFAULT gen_random_uuid(),
    room_id UUID REFERENCES rooms(id) ON DELETE CASCADE,
    user_id UUID REFERENCES users(id) ON DELETE CASCADE,
    join_order INTEGER NOT NULL, -- 1-4进入顺序
    player_role VARCHAR(20) DEFAULT 'explorer',
    fear_level INTEGER DEFAULT 0, -- 0-100
    status VARCHAR(20) DEFAULT 'active', -- active, sacrificed, revived, offline
    sacrifice_used BOOLEAN DEFAULT FALSE,
    x_position FLOAT DEFAULT 0, -- 3D坐标
    y_position FLOAT DEFAULT 0,
    z_position FLOAT DEFAULT 0,
    joined_at TIMESTAMP DEFAULT NOW(),
    left_at TIMESTAMP,

    UNIQUE(room_id, user_id)
);

-- 索引
CREATE INDEX idx_room_players_room ON room_players(room_id);
CREATE INDEX idx_room_players_user ON room_players(user_id);
CREATE INDEX idx_room_players_status ON room_players(status);
```

#### 8.1.4 情绪数据表 (emotion_data)
```sql
CREATE TABLE emotion_data (
    id UUID PRIMARY KEY DEFAULT gen_random_uuid(),
    room_id UUID REFERENCES rooms(id) ON DELETE CASCADE,
    player_id UUID REFERENCES room_players(id) ON DELETE CASCADE,
    timestamp TIMESTAMP DEFAULT NOW(),
    fear_value INTEGER NOT NULL CHECK (fear_value >= 0 AND fear_value <= 100),
    heart_rate INTEGER, -- BPM
    facial_expression VARCHAR(50),
    voice_tremor BOOLEAN DEFAULT FALSE,
    raw_data JSONB -- 原始检测数据
);

-- 索引
CREATE INDEX idx_emotion_room ON emotion_data(room_id, timestamp);
CREATE INDEX idx_emotion_player ON emotion_data(player_id, timestamp);
CREATE INDEX idx_emotion_timestamp ON emotion_data(timestamp);
```

#### 8.1.5 游戏事件表 (game_events)
```sql
CREATE TABLE game_events (
    id UUID PRIMARY KEY DEFAULT gen_random_uuid(),
    room_id UUID REFERENCES rooms(id) ON DELETE CASCADE,
    player_id UUID REFERENCES room_players(id) ON DELETE SET NULL,
    event_type VARCHAR(50) NOT NULL, -- jump, puzzle, sacrifice, rescue, escape
    event_data JSONB NOT NULL, -- 事件详情
    timestamp TIMESTAMP DEFAULT NOW(),

    CHECK (event_type IN ('jump', 'puzzle', 'sacrifice', 'rescue', 'escape', 'npc', 'clue'))
);

-- 索引
CREATE INDEX idx_events_room ON game_events(room_id, timestamp);
CREATE INDEX idx_events_type ON game_events(event_type);
```

#### 8.1.6 游戏结果表 (game_results)
```sql
CREATE TABLE game_results (
    id UUID PRIMARY KEY DEFAULT gen_random_uuid(),
    room_id UUID REFERENCES rooms(id) ON DELETE CASCADE,
    success BOOLEAN NOT NULL,
    completion_time INTEGER, -- 秒
    team_score INTEGER DEFAULT 0,
    team_achievements JSONB DEFAULT '[]',
    emotion_summary JSONB, -- 情绪统计
    created_at TIMESTAMP DEFAULT NOW()
);

-- 索引
CREATE INDEX idx_results_room ON game_results(room_id);
```

### 8.2 Redis缓存设计

#### 8.2.1 房间状态缓存
```python
# 房间基本信息
room:{room_id}:info = {
    "room_code": "ABC123",
    "status": "playing",
    "players": [
        {"user_id": "uuid1", "nickname": "玩家1", "x": 0, "y": 0, "z": 0},
        ...
    ],
    "scene_state": {...},
    "fear_levels": {"uuid1": 45, "uuid2": 67, ...},
    "last_update": timestamp
}
# 过期时间：房间结束后5分钟
```

#### 8.2.2 玩家状态缓存
```python
# 单个玩家状态
player:{player_id}:state = {
    "position": {"x": 0, "y": 0, "z": 0},
    "fear_level": 45,
    "status": "active",
    "inventory": ["key", "note"],
    "last_heartbeat": timestamp
}
# 过期时间：60秒（心跳超时判定离线）
```

#### 8.2.3 情绪数据缓存
```python
# 最近30秒情绪数据
emotion:{room_id}:recent = [
    {"player_id": "uuid1", "fear": 45, "ts": timestamp},
    ...
]
# 定期写入数据库后清空
# 过期时间：1分钟
```

### 8.3 数据流转图

```
┌─────────┐    ┌─────────┐    ┌─────────┐    ┌─────────┐
│ 客户端  │ -> │ WebSocket│ -> │  缓存   │ -> │ 数据库  │
│ 情绪检测│    │  服务    │    │ (Redis) │    │ (PG)    │
└─────────┘    └─────────┘    └─────────┘    └─────────┘
     │               │               │               │
     │               │               │               │
  数据采集        实时广播         状态存储         持久化
     │               │               │               │
     v               v               v               v
 face-api.js    Socket.io    状态管理     定时任务
 MediaPipe      FastAPI      过期清理     写入磁盘
 Tone.js        WebSocket    读写分离
```

---

## 9. 接口设计

### 9.1 WebSocket 实时通信协议

#### 9.1.1 客户端 → 服务端消息

**JOIN_ROOM（加入房间）**
```json
{
    "type": "JOIN_ROOM",
    "room_code": "ABC123",
    "user_id": "uuid-123",
    "nickname": "玩家1"
}
```

**PLAYER_MOVE（玩家移动）**
```json
{
    "type": "PLAYER_MOVE",
    "room_id": "uuid-room",
    "player_id": "uuid-player",
    "position": {"x": 1.5, "y": 0, "z": 2.3},
    "timestamp": 1729123456
}
```

**EMOTION_DATA（情绪数据）**
```json
{
    "type": "EMOTION_DATA",
    "room_id": "uuid-room",
    "player_id": "uuid-player",
    "fear_level": 67,
    "heart_rate": 95,
    "facial_expression": "fear",
    "voice_tremor": true,
    "timestamp": 1729123456
}
```

**INTERACT（交互）**
```json
{
    "type": "INTERACT",
    "room_id": "uuid-room",
    "player_id": "uuid-player",
    "action": "open_door", -- open_door, pickup_item, read_note等
    "target_id": "door_001", -- 交互对象ID
    "position": {"x": 1.5, "y": 0, "z": 2.3},
    "timestamp": 1729123456
}
```

**SACRIFICE（牺牲）**
```json
{
    "type": "SACRIFICE",
    "room_id": "uuid-room",
    "player_id": "uuid-player",
    "timestamp": 1729123456
}
```

#### 9.1.2 服务端 → 客户端消息

**ROOM_JOINED（加入成功）**
```json
{
    "type": "ROOM_JOINED",
    "success": true,
    "room_id": "uuid-room",
    "room_info": {
        "room_code": "ABC123",
        "players": [
            {"user_id": "uuid1", "nickname": "玩家1", "status": "waiting"},
            ...
        ],
        "max_players": 4
    }
}
```

**PLAYER_MOVED（玩家移动广播）**
```json
{
    "type": "PLAYER_MOVED",
    "player_id": "uuid-player",
    "position": {"x": 1.5, "y": 0, "z": 2.3},
    "timestamp": 1729123456
}
```

**EMOTION_UPDATE（情绪更新）**
```json
{
    "type": "EMOTION_UPDATE",
    "room_id": "uuid-room",
    "players": [
        {"player_id": "uuid1", "fear_level": 45},
        {"player_id": "uuid2", "fear_level": 67},
        ...
    ],
    "average_fear": 58
}
```

**JUMPSCARE（惊吓触发）**
```json
{
    "type": "JUMPSCARE",
    "trigger": "open_cabinet", -- 触发原因
    "intensity": 0.8, -- 0-1强度
    "duration": 2, -- 秒
    "message": "你打开了不该打开的柜子...",
    "timestamp": 1729123456
}
```

**PUZZLE_UPDATE（谜题进度）**
```json
{
    "type": "PUZZLE_UPDATE",
    "room_id": "uuid-room",
    "main_puzzle": {
        "floor_1": {"status": "completed", "clues_found": 3},
        "floor_2": {"status": "in_progress", "clues_found": 2},
        "floor_3": {"status": "locked", "clues_found": 0},
        "floor_4": {"status": "locked", "clues_found": 0}
    },
    "dependency_unlocked": ["floor_2"] -- 新解锁的楼层
}
```

**SACRIFICE_TRIGGERED（牺牲触发）**
```json
{
    "type": "SACRIFICE_TRIGGERED",
    "sacrificed_player": "uuid-player",
    "rescue_task": {
        "task_type": "collective_sing",
        "description": "全队一起唱生日歌",
        "time_limit": 120, -- 秒
        "progress": 0
    }
}
```

**GAME_ENDED（游戏结束）**
```json
{
    "type": "GAME_ENDED",
    "success": true,
    "duration": 2745, -- 总时长秒
    "team_score": 850,
    "achievements": [
        {"type": "best_partner", "player_id": "uuid1"},
        {"type": "fear_master", "player_id": "uuid2"}
    ],
    "emotion_summary": {
        "average_fear": 58,
        "peak_fear": 92,
        "sacrifice_count": 1,
        "teamwork_score": 90
    }
}
```

### 9.2 REST API 设计

#### 9.2.1 房间管理

**POST /api/rooms/create**
```http
POST /api/rooms/create
Content-Type: application/json
Authorization: Bearer {token}

{
    "room_name": "我的鬼屋",
    "scene_type": "hospital",
    "max_players": 4,
    "settings": {
        "difficulty": "normal",
        "music_volume": 0.8
    }
}
```

响应：
```json
{
    "success": true,
    "room_id": "uuid-room",
    "room_code": "ABC123",
    "join_url": "https://game.com/join/ABC123"
}
```

**GET /api/rooms/{room_code}**
```http
GET /api/rooms/ABC123
Authorization: Bearer {token}
```

响应：
```json
{
    "success": true,
    "room": {
        "room_id": "uuid-room",
        "room_code": "ABC123",
        "room_name": "我的鬼屋",
        "status": "waiting",
        "players": [
            {
                "user_id": "uuid1",
                "nickname": "玩家1",
                "status": "waiting",
                "join_order": 1
            }
        ],
        "max_players": 4,
        "created_at": "2025-10-30T12:00:00Z"
    }
}
```

#### 9.2.2 游戏结果

**POST /api/rooms/{room_id}/results**
```http
POST /api/rooms/uuid-room/results
Content-Type: application/json
Authorization: Bearer {token}

{
    "success": true,
    "duration": 2745,
    "player_performance": [
        {
            "player_id": "uuid1",
            "fear_management": 85,
            "teamwork_score": 90,
            "clues_found": 5
        }
    ]
}
```

响应：
```json
{
    "success": true,
    "result_id": "uuid-result",
    "ranking": {
        "team_score": 850,
        "achievements": [
            {"type": "escape_success", "name": "成功逃脱"},
            {"type": "sacrifice", "name": "英勇牺牲", "player": "玩家1"}
        ]
    }
}
```

**GET /api/rooms/{room_id}/results**
```http
GET /api/rooms/uuid-room/results
Authorization: Bearer {token}
```

响应：
```json
{
    "success": true,
    "results": {
        "success": true,
        "duration": 2745,
        "team_score": 850,
        "achievements": [...],
        "emotion_data": {
            "chart_data": [...], -- Base64编码图表
            "average_fear": 58,
            "peak_moment": "35:42",
            "most_scary_player": "玩家2"
        },
        "team_photo": "https://cdn.com/photo.jpg"
    }
}
```

### 9.3 错误码定义

| 错误码 | 含义 | HTTP状态码 | 说明 |
|--------|------|------------|------|
| 1001 | ROOM_NOT_FOUND | 404 | 房间不存在 |
| 1002 | ROOM_FULL | 409 | 房间已满 |
| 1003 | INVALID_ROOM_CODE | 400 | 房间码错误 |
| 1004 | GAME_NOT_STARTED | 400 | 游戏未开始 |
| 1005 | GAME_ALREADY_STARTED | 409 | 游戏已开始 |
| 2001 | PLAYER_NOT_IN_ROOM | 403 | 玩家不在房间 |
| 2002 | SACRIFICE_ALREADY_USED | 409 | 牺牲机会已使用 |
| 3001 | WEBSOCKET_ERROR | 1011 | WebSocket连接错误 |
| 3002 | EMOTION_DATA_INVALID | 400 | 情绪数据无效 |

---

## 10. UI/UX原型

### 10.1 页面架构

```
登录/注册页
    │
    ├── 房间列表页
    │   ├── 创建房间
    │   ├── 加入房间
    │   └── 快速匹配
    │
    ├── 房间等待页
    │   ├── 玩家列表
    │   ├── 聊天区
    │   ├── 设置面板
    │   └── 开始游戏
    │
    └── 游戏主界面
        ├── 3D场景视图 (60%区域)
        │   ├── 玩家角色
        │   ├── 可交互物体
        │   └── 恐怖效果
        │
        ├── 侧边栏 (20%区域)
        │   ├── 任务板
        │   ├── 道具栏
        │   ├── 楼层地图
        │   └── 队友状态
        │
        ├── 底部工具栏 (10%区域)
        │   ├── 聊天输入
        │   ├── 语音按钮
        │   ├── 表情按钮
        │   └── 设置按钮
        │
        └── 情绪可视化 (右上角)
            ├── 恐惧云图
            ├── 个人情绪曲线
            └── 团队情绪雷达图
```

### 10.2 关键页面设计

#### 10.2.1 房间等待页

**布局描述**：
```
┌─────────────────────────────────────────────┐
│  房间名: 我的鬼屋    房间码: ABC123    [设置] │
├─────────────────────────────────────────────┤
│  玩家列表 (4/4)                              │
│  ┌────────────┐ ┌────────────┐              │
│  │ 玩家1      │ │ 玩家2      │              │
│  │ 在线 ✓     │ │ 在线 ✓     │              │
│  │ [头像]     │ │ [头像]     │              │
│  └────────────┘ └────────────┘              │
│  ┌────────────┐ ┌────────────┐              │
│  │ 玩家3      │ │ 玩家4      │              │
│  │ 在线 ✓     │ │ 在线 ✓     │              │
│  │ [头像]     │ │ [头像]     │              │
│  └────────────┘ └────────────┘              │
├─────────────────────────────────────────────┤
│  聊天区                                      │
│  ┌─────────────────────────────────────────┐│
│  │ 玩家1: 大家好！                          ││
│  │ 玩家2: 期待~                             ││
│  │ 玩家1: 我有点紧张哈哈                    ││
│  └─────────────────────────────────────────┘│
│  [输入框...] [发送] [语音] [表情]            │
├─────────────────────────────────────────────┤
│  [游戏说明] [角色选择]         [开始游戏]     │
└─────────────────────────────────────────────┘
```

**交互细节**：
- 玩家头像：显示昵称、在线状态、准备状态
- 房间码：可复制，分享给朋友
- 聊天区：实时滚动，支持表情包
- 开始游戏：房主按钮，需要4人全部就绪

#### 10.2.2 游戏主界面

**布局描述**：
```
┌───────────────────────────────────────────────────────────┐
│  倒计时: 38:27  楼层: 2/4    线索: 3/8  [设置] [退出]       │
├───────────────────────────────────────────────────────────┤
│                                                           │
│              ┌────────────────────────────────┐           │
│              │                                │           │
│              │         3D 鬼屋场景            │           │
│              │    (Three.js 渲染)            │           │
│              │                                │           │
│              │  [玩家] [柜子] [门] [线索]      │           │
│              │                                │           │
│              │     ✨ Jump效果区域 ✨          │           │
│              └────────────────────────────────┘           │
│                                                           │
├───────────────────┬───────────────────┬───────────────────┤
│  任务板            │   道具栏           │   楼层地图         │
│  ├ 主线任务        │  ┌─────────────┐   │   ┌───────────┐   │
│  │ ✓ 1楼钥匙       │  │ 钥匙 ×1     │   │   │ 1F [✓]    │   │
│  │ ○ 2楼供电       │  │ 纸条 ×2     │   │   │ 2F [正在] │   │
│  │ ○ 3楼档案       │  │ 未知物品    │   │   │ 3F [锁定] │   │
│  │ ○ 4楼逃生       │  └─────────────┘   │   │ 4F [锁定] │   │
│  ├ 支线任务        │                   │   └───────────┘   │
│  │ ○ 寻找照片      │   队友状态        │   线索分布图       │
│  │ ○ 打开保险箱    │   玩家1: 45恐惧   │   🔴线索已发现     │
│  └ 进度: 25%       │   玩家2: 67恐惧   │   ⚫线索未发现     │
│                   │   玩家3: 52恐惧   │   ⭐重要线索       │
│                   │   玩家4: 38恐惧   │                   │
│                   └───────────────────┘                   │
├───────────────────────────────────────────────────────────┤
│ [聊天输入框...] [语音] [表情] [共享视角] [牺牲] [求助]       │
└───────────────────────────────────────────────────────────┘
               ┌─────────────────────────┐
               │  情绪可视化面板 (弹出)   │
               │  ┌───────────────────┐   │
               │  │   恐惧云图        │   │
               │  │   [实时热力图]    │   │
               │  └───────────────────┘   │
               │  ┌───────────────────┐   │
               │  │ 情绪曲线 (折线)    │   │
               │  │ [个人/团队切换]    │   │
               │  └───────────────────┘   │
               └─────────────────────────┘
```

**关键UI组件**：

1. **3D场景视图**
   - 占据中心60%区域
   - 第一人称视角，支持鼠标转向
   - WASD移动，空格跳跃
   - 可交互物体高亮提示（鼠标悬停）
   - Jump效果：全屏闪烁+音效+震动（可选）

2. **情绪可视化**
   - 右上角云图按钮点击弹出
   - 恐惧云图：4个玩家位置的热力分布
   - 颜色编码：红色(高恐惧) → 蓝色(平静)
   - 粒子效果：恐惧越高粒子越剧烈
   - 团队情绪雷达图：4维度对比

3. **任务系统**
   - 左侧任务板，实时更新进度
   - 依赖关系可视化（箭头连线）
   - 完成的任务绿色勾选
   - 当前进行中任务闪烁提示
   - 支线任务淡灰色显示

4. **队友状态**
   - 实时显示队友恐惧值
   - 头像框颜色反映状态（正常/紧张/恐惧/牺牲）
   - 点击队友头像可查看其视角（共享视角功能）
   - 牺牲状态显示特殊光效

### 10.3 响应式设计

#### 桌面端 (≥1200px)
- 标准布局如上所述
- 3D场景全屏显示
- 侧边栏固定宽度
- 情绪面板悬浮显示

#### 平板端 (768px-1199px)
- 侧边栏可折叠
- 3D场景缩小至50%区域
- 情绪面板改为标签页
- 任务列表纵向排列

#### 手机端 (≤767px)
- 不支持游戏（性能限制）
- 纯观察模式：观看队友视角
- 仅显示聊天和情绪数据
- 提供加入房间功能

### 10.4 交互细节

#### 鼠标/键盘操作
| 操作 | 桌面端 | 移动端 |
|------|--------|--------|
| 移动 | WASD/方向键 | 虚拟摇杆 |
| 转向 | 鼠标移动 | 滑动屏幕 |
| 交互 | 鼠标左键 | 触摸 |
| 跳跃 | 空格键 | 虚拟按钮 |
| 跑步 | Shift | 双击摇杆 |
| 视角共享 | F1键 | 顶部按钮 |

#### 状态指示
- 正常：头像白色边框
- 紧张：头像黄色边框
- 恐惧：头像红色边框+脉动效果
- 牺牲：头像灰色+禁锢图标
- 离线：头像灰色透明度50%

#### 反馈动画
- 交互成功：绿色✓ + 提示音
- 交互失败：红色✗ + 错误音
- 任务完成：烟花效果+庆祝音
- 团队救赎：光芒特效+圣光音效
- 游戏胜利：彩带+胜利BGM

---

## 11. 验收标准

### 11.1 功能验收标准

#### F1: 多人协作系统
| 测试项 | 验收标准 | 测试方法 |
|--------|----------|----------|
| 房间创建 | 1秒内生成6位房间码 | 连续创建100个房间 |
| 房间加入 | 5秒内完成加入 | 使用正确/错误房间码测试 |
| 玩家同步 | 延迟≤100ms | 网络监控工具检测 |
| 状态广播 | 1秒内全队收到 | 3台设备同时测试 |
| 协作解谜 | 4楼层依赖正确 | 完整游戏流程测试 |

#### F2: 情绪识别系统
| 测试项 | 验收标准 | 测试方法 |
|--------|----------|----------|
| 面部识别 | 准确率≥85% | 100次不同表情测试 |
| 心率监测 | 误差≤±5 BPM | 对比专业设备 |
| 语音分析 | 颤抖识别率≥80% | 录制颤抖/正常语音对比 |
| 恐惧值计算 | 响应时间≤1秒 | 压力测试，实时监控 |
| 数据可视化 | 帧率≥30 FPS | 性能分析工具 |

#### F3: 游戏逻辑引擎
| 测试项 | 验收标准 | 测试方法 |
|--------|----------|----------|
| 场景渲染 | 加载时间≤3秒 | 冷启动测试 |
| 谜题生成 | 逻辑依赖正确 | 人工验证所有路径 |
| 惊吓触发 | 剧情化，非随机 | 完整流程检查 |
| 情绪自适应 | 10秒内响应变化 | 模拟极端情绪波动 |
| 游戏结算 | 准确计算分数 | 人工计算对比 |

#### F4: 牺牲与救赎
| 测试项 | 验收标准 | 测试方法 |
|--------|----------|----------|
| 牺牲触发 | 限1次/人 | 连续触发测试 |
| 救赎任务 | 2分钟限制 | 计时测试 |
| 复活机制 | 成功后立即复活 | 观察复活动画 |
| 情感激励 | 庆祝效果完整 | 完整流程体验 |

#### F5: 虚实融合
| 测试项 | 验收标准 | 测试方法 |
|--------|----------|----------|
| 小黑屋联动 | 5秒内同步 | 实际测试 |
| 现实线索 | 识别率≥90% | 多次测试 |
| NPC互动 | 触发时机准确 | 完整流程 |
| Jumpscare联动 | 全队同步 | 4人同时测试 |

### 11.2 性能验收标准

#### 11.2.1 前端性能
| 指标 | 目标值 | 测量工具 |
|------|--------|----------|
| 首屏加载 | ≤3秒 | Lighthouse |
| 3D渲染帧率 | ≥30 FPS | Chrome DevTools |
| 内存占用 | ≤500MB | 任务管理器 |
| CPU占用 | ≤50%（平均） | 性能监视器 |
| 电池消耗 | 中等 | 1小时连续游戏 |

#### 11.2.2 后端性能
| 指标 | 目标值 | 测量方法 |
|------|--------|----------|
| API响应时间 | ≤200ms（平均） | Apache Bench |
| WebSocket延迟 | ≤100ms | Ping测试 |
| 并发连接 | ≥100个房间 | 压力测试 |
| 数据库查询 | ≤50ms | PostgreSQL日志 |
| Redis缓存命中率 | ≥90% | Redis监控 |

#### 11.2.3 网络要求
| 场景 | 最低要求 | 推荐配置 |
|------|----------|----------|
| 带宽 | 5 Mbps | 10 Mbps |
| 延迟 | ≤100ms | ≤50ms |
| 抖动 | ≤20ms | ≤10ms |
| 丢包率 | ≤1% | ≤0.1% |

### 11.3 兼容性验收标准

#### 11.3.1 浏览器兼容
| 浏览器 | 版本要求 | 功能支持率 |
|--------|----------|------------|
| Chrome | ≥100 | 100% |
| Edge | ≥100 | 100% |
| Firefox | ≥100 | 95%（WebRTC差异） |
| Safari | ≥15 | 90%（部分WebGL特性） |

#### 11.3.2 设备兼容
| 设备类型 | 最低配置 | 测试覆盖 |
|----------|----------|----------|
| 笔记本 | 8GB内存, 集显 | 必测 |
| 台式机 | 8GB内存, 独显 | 必测 |
| MacBook | 8GB内存 | 必测 |
| 平板 | 不支持游戏 | 观察模式 |

### 11.4 现场演示验收标准

#### 11.4.1 演示流程（10分钟）
| 时间 | 内容 | 验收标准 |
|------|------|----------|
| 0-1' | 开场介绍 | 清晰说明主题和价值 |
| 1-3' | 团队入场 | 4人快速破冰，建立信任 |
| 3-6' | 核心玩法展示 | 协作解谜，情绪识别 |
| 6-8' | 高潮体验 | Jump + 牺牲 + 救赎 |
| 8-10' | 结果与价值 | 情绪可视化，成功逃脱 |

#### 11.4.2 演示成功标准
- ✅ 完整游戏流程，无技术故障
- ✅ 4人团队协作流畅，沟通自然
- ✅ 情绪识别准确，可视化震撼
- ✅ Jump触发符合剧情，非突兀
- ✅ 牺牲救赎环节感人肺腑
- ✅ 现场观众主动参与体验
- ✅ 评委/观众印象深刻，传播性强

### 11.5 用户体验验收标准

#### 11.5.1 主观体验
| 维度 | 目标分数（5分制） | 评估方法 |
|------|-------------------|----------|
| 沉浸感 | ≥4.5 | 现场询问 |
| 恐怖感 | 4.0（不过度） | 情绪反馈 |
| 团队感 | ≥4.5 | 团队归属调查 |
| 成就感 | ≥4.5 | 成功逃脱反馈 |
| 难忘度 | ≥4.5 | 一周后回访 |

#### 11.5.2 客观指标
- 房间留存率：≥90%（完成游戏）
- 情绪曲线完整性：5个阶段完整
- 社交互动频次：≥15次/50分钟
- 相互救赎触发率：≥50%房间
- 分享意愿：≥80%愿意推荐朋友

---

## 12. 项目计划

### 12.1 24小时开发时间表

#### 第一天（0-8小时）：基础搭建

**阶段0: 项目启动 (0:00-0:30)**
- [x] 团队角色分工确认
- [x] 开发环境搭建
- [x] 代码仓库初始化
- [x] API密钥注册
- [x] 基础框架搭建

**阶段1: 后端核心 (0:30-3:30)**
- [ ] FastAPI项目初始化 (30min)
- [ ] 数据库模型设计 (30min)
- [ ] Redis缓存配置 (30min)
- [ ] WebSocket服务开发 (60min)
- [ ] 房间管理API (60min)
- [ ] 状态同步服务 (60min)

**阶段2: 前端基础 (3:30-6:30)**
- [ ] React项目初始化 (30min)
- [ ] Next.js页面搭建 (60min)
- [ ] Three.js场景基础 (90min)
- [ ] WebSocket客户端 (60min)
- [ ] 基础UI组件 (90min)

**阶段3: 集成测试 (6:30-8:00)**
- [ ] 前后端接口联调 (45min)
- [ ] 基础功能测试 (45min)

**里程碑1：基础框架完成**
- ✅ 房间创建/加入
- ✅ 玩家状态同步
- ✅ 基础3D场景渲染
- ✅ 文字聊天

#### 第二天（8-16小时）：核心功能

**阶段4: 游戏逻辑 (8:00-11:00)**
- [ ] 场景状态管理 (60min)
- [ ] 谜题生成器 (60min)
- [ ] 任务依赖系统 (60min)
- [ ] 交互逻辑 (60min)

**阶段5: 情绪系统 (11:00-14:00)**
- [ ] MediaPipe集成 (60min)
- [ ] 心率检测 (60min)
- [ ] 语音颤抖分析 (60min)
- [ ] 情绪值计算 (60min)
- [ ] 情绪可视化 (60min)

**阶段6: 惊吓机制 (14:00-16:00)**
- [ ] Jumpscare触发器 (60min)
- [ ] 恐怖音效系统 (60min)
- [ ] 剧情化Jump设计 (60min)
- [ ] 全队同步机制 (60min)

**里程碑2：核心功能完成**
- ✅ 协作解谜流程
- ✅ 情绪识别与可视化
- ✅ 惊吓触发机制
- ✅ 4楼层联动

#### 第三天（16-24小时）：优化完善

**阶段7: 高级功能 (16:00-19:00)**
- [ ] 牺牲与救赎系统 (90min)
- [ ] NPC干扰系统 (60min)
- [ ] 小黑屋联动 (90min)
- [ ] 虚实融合优化 (60min)

**阶段8: 打磨优化 (19:00-22:00)**
- [ ] 性能优化 (90min)
- [ ] UI/UX打磨 (90min)
- [ ] 错误处理完善 (60min)
- [ ] 边界情况测试 (60min)

**阶段9: 演示准备 (22:00-24:00)**
- [ ] 演示脚本编写 (30min)
- [ ] 演示流程彩排 (60min)
- [ ] 现场演示模拟 (30min)
- [ ] 最终测试 (30min)

**里程碑3：产品交付**
- ✅ 所有功能完成
- ✅ 性能达标
- ✅ 演示流程流畅
- ✅ 应急预案准备

### 12.2 团队分工

#### 产品经理（1人）
**职责**：
- 用户体验设计
- 需求管理
- 进度把控
- 现场演示讲解
- NPC互动协调

**关键交付物**：
- [ ] UI/UX设计稿
- [ ] 用户故事文档
- [ ] 演示脚本
- [ ] 现场互动话术

#### 前端1（1人）
**职责**：
- React应用开发
- Three.js 3D渲染
- 情绪可视化
- 客户端性能优化

**关键交付物**：
- [ ] 3D场景渲染模块
- [ ] 情绪识别界面
- [ ] 可视化图表组件
- [ ] 客户端性能优化

#### 前端2（1人）
**职责**：
- Next.js服务端渲染
- WebSocket实时通信
- 多人协作界面
- 响应式布局

**关键交付物**：
- [ ] 实时协作系统
- [ ] 房间管理界面
- [ ] 任务板组件
- [ ] 聊天通信模块

#### 后端（1人）
**职责**：
- FastAPI框架搭建
- WebSocket服务
- 游戏逻辑引擎
- 数据存储管理

**关键交付物**：
- [ ] RESTful API
- [ ] WebSocket服务
- [ ] 游戏逻辑系统
- [ ] 数据库设计

### 12.3 里程碑检查点

#### 里程碑1 (T+8小时)
**验收标准**：
- [ ] 房间系统正常运行
- [ ] 基础3D场景可见
- [ ] 4人可同时在线
- [ ] 文字聊天正常

**未完成项处理**：
- 砍掉高级功能，专注核心流程
- 降级方案：静态场景，无动态元素
- 应急方案：使用演示视频

#### 里程碑2 (T+16小时)
**验收标准**：
- [ ] 协作解谜可完整体验
- [ ] 情绪识别数据准确
- [ ] 惊吓触发符合预期
- [ ] 情绪可视化呈现

**未完成项处理**：
- 使用预设情绪数据
- 手动触发惊吓
- 砍掉情绪可视化

#### 里程碑3 (T+24小时)
**验收标准**：
- [ ] 完整游戏流程演示
- [ ] 无致命Bug
- [ ] 演示流畅
- [ ] 团队配合默契

**应急预案**：
- 准备演示视频
- 功能降级说明
- 技术问题FAQ

---

## 13. 风险评估

### 13.1 技术风险

#### 高风险 (概率≥60%，影响≥8/10)

**T1: WebRTC视频共享失败**
- **风险描述**：不同网络环境下WebRTC连接不稳定
- **影响程度**：高（核心功能缺失）
- **概率**：中（60%）
- **应对措施**：
  - 备选方案：使用服务器中转（SFU）
  - 降级方案：共享屏幕截图而非实时视频
  - 测试覆盖：多网络环境测试（WiFi/4G/5G）
  - 时间预留：2小时解决时间
- **应急预案**：砍掉视频共享，专注情绪识别

**T2: MediaPipe性能瓶颈**
- **风险描述**：30FPS情绪识别可能导致卡顿
- **影响程度**：中（影响体验）
- **概率**：中（50%）
- **应对措施**：
  - 优化：降低识别频率至15FPS
  - 技术：Web Workers后端处理
  - 硬件：要求设备不低于8GB内存
  - 监控：实时性能检测，动态调整
- **应急预案**：使用手动情绪评分（1-5分按钮）

**T3: Three.js渲染性能**
- **风险描述**：复杂场景导致帧率低于30FPS
- **影响程度**：中（影响沉浸感）
- **概率**：中（50%）
- **应对措施**：
  - 优化：LOD（细节层次）技术
  - 优化：遮挡剔除
  - 优化：纹理压缩
  - 降级：低配设备自动降低画质
- **应急预案**：使用预渲染360度全景图

#### 中风险 (概率40-60%，影响5-8/10)

**T4: WebSocket连接不稳定**
- **风险描述**：网络波动导致频繁断线
- **概率**：中（40%）
- **应对措施**：
  - 自动重连机制
  - 心跳检测（30秒超时）
  - 状态本地缓存，断线重连恢复
  - 重连失败使用HTTP轮询
- **监控**：连接状态实时监控

**T5: 情绪识别准确率低**
- **风险描述**：算法准确率低于85%标准
- **概率**：中（30%）
- **应对措施**：
  - 多模态融合（面部+心率+语音）
  - 人工校准：现场工作人员辅助
  - 机器学习：收集数据实时调优
  - 降级：用户手动调节恐惧值
- **测试**：现场20人测试调优

**T6: 多人同步延迟**
- **风险描述**：网络延迟导致操作不同步
- **概率**：低（30%）
- **应对措施**：
  - 客户端预测算法
  - 服务器时间同步
  - 延迟补偿机制
  - 操作回滚机制
- **标准**：延迟≤100ms

#### 低风险 (概率<40%，影响<5/10)

**T7: API限额超限**
- **概率**：低（20%）
- **应对措施**：
  - 提前测试API限额
  - 准备多个备用API Key
  - 本地缓存减少请求
  - 降级：使用离线模型

**T8: 浏览器兼容性问题**
- **概率**：低（15%）
- **应对措施**：
  - Polyfill填充
  - 特性检测
  - 优雅降级
  - 现场准备4个不同浏览器

### 13.2 项目风险

**P1: 开发进度滞后**
- **风险**：复杂功能导致无法按时完成
- **概率**：中（40%）
- **应对措施**：
  - 每日站会，进度监控
  - 砍功能保核心（MVP思维）
  - 团队互助，高手支援
  - 砍开发时间，延长测试时间
- **优先级**：
  - P0：房间系统+基础3D+协作
  - P1：情绪识别+惊吓
  - P2：牺牲救赎+虚实融合

**P2: 团队配合失误**
- **风险**：分工不明确导致重复或遗漏
- **概率**：中（30%）
- **应对措施**：
  - 明确分工文档
  - Git分支管理
  - 代码审查机制
  - 每日沟通同步
- **决策机制**：产品经理最终拍板

**P3: 现场网络问题**
- **风险**：现场WiFi不稳定或速度慢
- **概率**：高（70%）
- **应对措施**：
  - 准备4G/5G热点备用
  - 局域网部署（本地服务器）
  - 功能降级：单人演示模式
  - 离线模式：本地缓存所有资源
- **最坏情况**：使用演示视频

### 13.3 业务风险

**B1: 用户不接受恐怖元素**
- **风险**：过度恐怖吓跑用户
- **概率**：中（30%）
- **应对措施**：
  - 恐怖程度分级选择
  - NPC引导缓冲情绪
  - 强调社交价值大于恐怖刺激
  - 提供"无惊吓"模式
- **测试**：内部5人团队测试

**B2: 隐私担忧**
- **风险**：用户担心情绪数据隐私
- **概率**：中（40%）
- **应对措施**：
  - 明确告知：本地处理，不上传
  - 现场同意书签署
  - 数据加密传输
  - 结束后立即删除
- **透明化**：现场屏幕显示数据处理流程

### 13.4 风险应对矩阵

| 风险 | 概率 | 影响 | 优先级 | 应对策略 |
|------|------|------|--------|----------|
| WebRTC失败 | 60% | 高 | P1 | 备用方案+降级 |
| MediaPipe性能 | 50% | 中 | P1 | 优化+手动备选 |
| Three.js性能 | 50% | 中 | P1 | LOD+降级 |
| 网络不稳定 | 70% | 高 | P0 | 热点+本地部署 |
| 进度滞后 | 40% | 高 | P0 | 砍功能保核心 |
| 用户不接受 | 30% | 中 | P2 | 分级+引导 |

### 13.5 应急预案

#### 场景1：核心功能崩溃
**症状**：无法创建房间或连接
**应对**：
1. 立即切换到演示视频模式
2. 技术负责人5分钟内定位问题
3. 10分钟内修复或确认无法修复
4. 启动备用方案：预录制演示

#### 场景2：多人同步异常
**症状**：玩家位置不同步或延迟严重
**应对**：
1. 切换到单人演示模式
2. 演示情绪识别功能
3. 展示UI/UX设计
4. 解释技术架构和逻辑

#### 场景3：情绪识别失效
**症状**：无法识别面部或心率
**应对**：
1. 切换到手动评分模式
2. 现场工作人员手动输入
3. 演示情绪可视化界面
4. 说明算法原理

#### 场景4：Jumpscare插件冲突
**症状**：插件导致游戏崩溃
**应对**：
1. 关闭插件，使用内置惊吓
2. 重点演示情绪系统和协作
3. 说明插件集成思路
4. 展示NPC干扰功能

#### 场景5：完全无法演示
**最坏情况**：所有功能失效
**应对**：
1. 播放完整演示视频（5分钟）
2. 团队成员口述产品价值
3. 展示设计稿和原型
4. 回答评委技术问题
5. 承诺赛后完整实现

---

## 14. 成功指标

### 14.1 技术指标

#### 14.1.1 性能指标
| 指标类别 | 具体指标 | 目标值 | 测量方法 | 权重 |
|----------|----------|--------|----------|------|
| 加载性能 | 首屏加载时间 | ≤3秒 | 浏览器开发者工具 | 15% |
| 渲染性能 | 3D场景帧率 | ≥30 FPS | Chrome Performance | 20% |
| 响应性能 | 操作响应时间 | ≤100ms | 手动测试 | 15% |
| 通信性能 | WebSocket延迟 | ≤100ms | 网络监控 | 15% |
| 识别性能 | 情绪识别准确率 | ≥85% | 人工验证100次 | 20% |
| 并发性能 | 4人同时在线稳定 | 0崩溃 | 压力测试 | 15% |

**总性能得分**：所有指标加权平均 ≥85分

#### 14.1.2 功能指标
| 功能模块 | 验收标准 | 权重 | 评分标准 |
|----------|----------|------|----------|
| 房间系统 | 创建/加入/同步 | 10% | 100%通过=10分 |
| 协作解谜 | 4楼层联动 | 20% | 100%通过=20分 |
| 情绪识别 | 多模态采集 | 20% | 准确率≥85%=20分 |
| 惊吓机制 | 剧情化触发 | 15% | 100%触发=15分 |
| 牺牲救赎 | 完整流程 | 15% | 100%通过=15分 |
| 虚实融合 | 小黑屋联动 | 10% | 100%触发=10分 |
| 情绪可视化 | 实时图表 | 10% | 100%显示=10分 |

**总功能得分**：所有功能加权平均 ≥90分

### 14.2 体验指标

#### 14.2.1 情绪曲线完整性
**评估方法**：完整体验游戏，记录情绪变化
| 阶段 | 目标情绪 | 实际体验 | 得分 |
|------|----------|----------|------|
| 组队阶段 | 好奇→期待→紧张 | 5分制评分 | 20分 |
| 探索阶段 | 焦虑→互助→发现 | 5分制评分 | 20分 |
| 惊吓阶段 | 恐惧→团结→支撑 | 5分制评分 | 20分 |
| 逃生阶段 | 心跳→绝境→求生 | 5分制评分 | 20分 |
| 逃脱时刻 | 成就→狂欢 | 5分制评分 | 20分 |

**目标**：每个阶段平均分≥4.0，总分≥80分

#### 14.2.2 社交连接效果
**评估方法**：现场问卷调查 + 行为观察
| 维度 | 指标 | 目标值 | 评估方式 |
|------|------|--------|----------|
| 破冰速度 | 从陌生到熟悉时间 | ≤10分钟 | 现场观察 |
| 沟通频次 | 协作对话次数 | ≥15次/50分钟 | 自动统计 |
| 相互信任 | 愿意牺牲比例 | ≥50% | 行为统计 |
| 情感共鸣 | 共同经历感受 | ≥4.5/5分 | 问卷调查 |
| 记忆深刻 | 一周后回忆清晰度 | ≥4.0/5分 | 事后回访 |

**目标**：综合评分≥4.5/5分

#### 14.2.3 用户满意度
**现场调查（5分制）**：
- 整体体验：≥4.5分
- 恐怖程度：4.0分（不过度）
- 团队协作：≥4.5分
- 情绪共鸣：≥4.5分
- 技术实现：≥4.0分
- 创意独特：≥4.5分
- 愿意推荐：≥80%

**事后调查（1周后）**：
- 记忆清晰度：≥4.0分
- 再次体验意愿：≥60%
- 推荐意愿：≥70%
- 愿意付费：≥30%

### 14.3 商业价值指标

#### 14.3.1 现场影响力
| 指标 | 目标值 | 评估方式 |
|------|--------|----------|
| 现场体验人数 | ≥50人 | 签到统计 |
| 主动参与率 | ≥80% | 观察统计 |
| 社交媒体传播 | ≥20条分享 | 现场监测 |
| 媒体报道 | ≥3家媒体报道 | 媒体监测 |
| 评委评分 | 前3名 | 最终排名 |

#### 14.3.2 技术创新度
| 创新维度 | 评估标准 | 得分标准 |
|----------|----------|----------|
| 算法创新 | 多模态情绪融合 | 独到=5分，一般=3分 |
| 体验创新 | 虚实融合协作 | 独到=5分，一般=3分 |
| 交互创新 | 情绪可视化社交 | 独到=5分，一般=3分 |
| 架构创新 | 实时多人情绪网络 | 独到=5分，一般=3分 |

**目标总分**：≥16/20分

#### 14.3.3 商业模式可行性
| 评估维度 | 具体指标 | 目标值 |
|----------|----------|--------|
| 市场潜力 | 目标用户规模 | ≥1000万 |
| 盈利模式 | 清晰盈利路径 | 3种以上 |
| 扩展性 | 多场景适用 | ≥5个场景 |
| 成本结构 | 开发/运营成本 | 可控 |
| 竞争力 | 差异化优势 | 明显 |

### 14.4 项目成功标准

#### 14.4.1 最低成功标准（60分）
- ✅ 所有P0功能完成
- ✅ 完整演示流程无致命错误
- ✅ 4人团队配合默契
- ✅ 现场观众基本认可
- ✅ 技术指标达标≥60%

#### 14.4.2 优秀成功标准（80分）
- ✅ P0 + 80% P1功能完成
- ✅ 情绪体验曲线完整
- ✅ 观众主动参与度高
- ✅ 社交传播效果明显
- ✅ 技术指标达标≥80%
- ✅ 获得评委好评

#### 14.4.3 卓越成功标准（95分）
- ✅ 所有P0 + P1功能完成
- ✅ 情绪识别创新突破
- ✅ 虚实融合体验震撼
- ✅ 媒体主动报道
- ✅ 技术指标达标≥95%
- ✅ 获得比赛前3名
- ✅ 多个投资/合作意向

### 14.5 成功评估方法

#### 14.5.1 实时监控
- **技术指标**：自动化监控dashboard
- **体验指标**：现场问卷（5分钟快速调查）
- **情绪数据**：实时采集与可视化

#### 14.5.2 事后评估
- **现场复盘**：团队内部30分钟总结
- **评委反馈**：收集所有评委意见
- **用户回访**：一周后电话/微信回访
- **数据复盘**：分析所有日志数据

#### 14.5.3 长期跟踪
- **GitHub Star**：开源后30天内≥100
- **媒体报道**：赛后1个月≥10篇
- **用户增长**：赛后3个月≥1000注册
- **商业转化**：赛后6个月≥1个付费客户

---

## 📊 结语

**共生·虚拟鬼屋**不仅仅是一款游戏产品，更是一次关于人类情感连接的深度探索。我们通过技术手段，将恐惧转化为信任，将陌生人转化为伙伴，将个体体验转化为集体记忆。

在24小时的极限开发中，我们将用代码编织一张情绪网络，让每一个心跳、每一次颤抖、每一个表情，都成为连接彼此的纽带。

**Hack the Panic, Before IT Hacks You.**

这是我们的承诺，也是我们的使命。

---

**文档结束**

*PRD-_SYMBIO-001-V1.0*
*最后更新：2025-10-30*